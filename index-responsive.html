<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M1 and Berowra Waters Cams</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#243244;
      --accent:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 14px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      background:rgba(11,15,23,0.92);
      backdrop-filter: blur(6px);
      z-index:10;
    }

    h1{
      margin:0 0 10px 0;
      font-size:18px;
      letter-spacing:0.2px;
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }

    .pill{
      padding:7px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(17,24,39,0.75);
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .pill strong{ color:var(--text); }

    button, select{
      font: inherit;
      cursor:pointer;
      padding:7px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      outline:none;
    }

    button:hover, select:hover{ border-color:var(--accent); }

    button:active{ transform: translateY(1px); }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(17,24,39,0.75);
      user-select:none;
    }

    .toggle input{ accent-color: var(--accent); }

    main{
      padding: clamp(12px, 2vw, 22px);
      max-width: 2200px;
      margin:0 auto;
    }

    /* Layout presets */
    body[data-layout="large"] .grid{ grid-template-columns: 1fr; }
    body[data-layout="standard"] .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    body[data-layout="dense"] .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }

    /* Responsive fallbacks */
    @media (max-width: 980px){
      body[data-layout="standard"] .grid{ grid-template-columns: 1fr; }
      body[data-layout="dense"] .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      body[data-layout="dense"] .grid{ grid-template-columns: 1fr; }
    }

    .grid{
      display:grid;
      gap: clamp(12px, 2vw, 18px);
      align-items:start;
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--panel);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 200px;
    }

    .card-header{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .card-title{
      font-weight:700;
      font-size:14px;
      line-height:1.2;
    }

    .card-header a{
      font-weight:600;
      font-size:12px;
      color:var(--accent);
      text-decoration:none;
      white-space:nowrap;
    }

    .img-wrap{
      position:relative;
      background:#000;
      overflow:hidden;
    }

    /* Image size tuning by layout */
    body[data-layout="large"] .img-wrap{ height: min(72vh, 980px); }
    body[data-layout="standard"] .img-wrap{ height: min(48vh, 560px); }
    body[data-layout="dense"] .img-wrap{ height: min(36vh, 460px); }

    /* On small screens, let image define height naturally */
    @media (max-width: 640px){
      .img-wrap{ height: auto !important; }
    }

    img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
    }

    @media (max-width: 640px){
      img{
        height:auto;
        object-fit: unset;
      }
    }

    .status{
      position:absolute;
      bottom:8px;
      left:8px;
      background:rgba(0,0,0,0.65);
      padding:4px 8px;
      border-radius:8px;
      font-size:11px;
      color:#fff;
    }

    .status.right{
      left:auto;
      right:8px;
      opacity:0.95;
    }

    .error{
      padding:14px;
      color:#fff;
      font-size:13px;
      line-height:1.4;
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
  </style>
</head>
<body data-layout="large">
  <header>
    <h1>M1 and Berowra Waters Cams</h1>
    <div class="meta">
      <div class="pill">Refresh: <strong id="refreshEvery">25s</strong></div>
      <div class="pill" id="lastRefresh">Last refresh: never</div>
      <div class="pill" id="nextRefresh">Next refresh: --</div>

      <button id="refreshNow" type="button">Refresh now</button>

      <label class="toggle" for="autoRefresh">
        <input id="autoRefresh" type="checkbox" checked />
        <span>Auto refresh</span>
      </label>

      <label class="pill" for="layoutSelect">
        <span>Layout</span>
        <span class="sr-only">Layout selector</span>
        <select id="layoutSelect">
          <option value="large">Large</option>
          <option value="standard">Standard</option>
          <option value="dense">Dense</option>
        </select>
      </label>
    </div>
  </header>

  <main>
    <div class="grid" id="camGrid" aria-live="polite"></div>
  </main>

  <script>
    const refreshMs = 25000;

    const cams = [
      { name: "HK River", url: "https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/m1_pacific_motorway_hawkesbury_river.jpeg" },
      { name: "Windy Banks", url: "https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/m1_pacific_motorway_windy_banks.jpeg" },
      { name: "Mt Colah", url: "https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/m1_pacific_mwy_mt_colah_north.jpeg" },
      { name: "Wahroonga", url: "https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/m1_pacific_motorway_wahroonga.jpeg" },
      { name: "Berowra Waters East", url: "https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/berowra_waters_ferry.jpeg" },
      { name: "Berowra Waters East Queue", url: "https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/berowra_waters_ferry_queue.jpeg" }
    ];

    const grid = document.getElementById("camGrid");
    const lastRefreshEl = document.getElementById("lastRefresh");
    const nextRefreshEl = document.getElementById("nextRefresh");
    const refreshEveryEl = document.getElementById("refreshEvery");
    const autoRefreshEl = document.getElementById("autoRefresh");
    const layoutSelectEl = document.getElementById("layoutSelect");

    refreshEveryEl.textContent = Math.round(refreshMs / 1000) + "s";

    function fmtTime(d){
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function cacheBusted(url){
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "t=" + Date.now();
    }

    function makeCard(cam){
      const card = document.createElement("section");
      card.className = "card";

      const header = document.createElement("div");
      header.className = "card-header";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = cam.name;

      const link = document.createElement("a");
      link.href = cam.url;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = "Open image";

      header.appendChild(title);
      header.appendChild(link);

      const wrap = document.createElement("div");
      wrap.className = "img-wrap";

      const img = document.createElement("img");
      img.alt = cam.name;
      img.loading = "lazy";
      img.decoding = "async";
      img.dataset.baseurl = cam.url;

      const status = document.createElement("div");
      status.className = "status";
      status.textContent = "Loadingâ€¦";

      const status2 = document.createElement("div");
      status2.className = "status right";
      status2.textContent = "";

      img.addEventListener("load", () => {
        status.textContent = "Updated " + fmtTime(new Date());
        status2.textContent = "OK";
      });

      img.addEventListener("error", () => {
        status.textContent = "Failed to load";
        status2.textContent = "Error";
        wrap.innerHTML = '<div class="error">Image did not load. The source may be unavailable or blocked by your network.</div>';
        wrap.appendChild(status);
        wrap.appendChild(status2);
      });

      wrap.appendChild(img);
      wrap.appendChild(status);
      wrap.appendChild(status2);

      card.appendChild(header);
      card.appendChild(wrap);

      img.src = cacheBusted(cam.url);
      return card;
    }

    function render(){
      grid.innerHTML = "";
      cams.forEach(cam => grid.appendChild(makeCard(cam)));
      updateLastRefresh();
    }

    function refreshAll(){
      document.querySelectorAll('img[data-baseurl]').forEach(img => {
        img.src = cacheBusted(img.dataset.baseurl);
      });
      updateLastRefresh();
    }

    function updateLastRefresh(){
      const now = new Date();
      lastRefreshEl.textContent = "Last refresh: " + fmtTime(now);
      scheduleNextRefresh(now);
    }

    let timer = null;
    let nextAt = null;
    let tickTimer = null;

    function scheduleNextRefresh(fromDate = new Date()){
      nextAt = new Date(fromDate.getTime() + refreshMs);
      nextRefreshEl.textContent = "Next refresh: " + fmtTime(nextAt);
    }

    function clearTimers(){
      if (timer) clearInterval(timer);
      if (tickTimer) clearInterval(tickTimer);
      timer = null;
      tickTimer = null;
    }

    function startTimers(){
      clearTimers();
      scheduleNextRefresh(new Date());
      timer = setInterval(() => {
        if (!document.hidden){
          refreshAll();
        } else {
          scheduleNextRefresh(new Date());
        }
      }, refreshMs);

      tickTimer = setInterval(() => {
        if (!nextAt){
          nextRefreshEl.textContent = "Next refresh: --";
          return;
        }
        const remaining = Math.max(0, nextAt.getTime() - Date.now());
        const s = Math.ceil(remaining / 1000);
        nextRefreshEl.textContent = "Next refresh: " + fmtTime(nextAt) + " (" + s + "s)";
      }, 1000);
    }

    function setLayout(layout){
      document.body.setAttribute("data-layout", layout);
      layoutSelectEl.value = layout;
      try{ localStorage.setItem("cams_layout", layout); } catch(e){}
    }

    function loadLayout(){
      try{
        const saved = localStorage.getItem("cams_layout");
        if (saved === "large" || saved === "standard" || saved === "dense") return saved;
      } catch(e){}
      return "large";
    }

    function setAutoRefresh(enabled){
      autoRefreshEl.checked = enabled;
      try{ localStorage.setItem("cams_autorefresh", enabled ? "1" : "0"); } catch(e){}
      if (enabled) startTimers();
      else clearTimers();
      nextRefreshEl.textContent = enabled ? nextRefreshEl.textContent : "Next refresh: paused";
    }

    function loadAutoRefresh(){
      try{
        return localStorage.getItem("cams_autorefresh") !== "0";
      } catch(e){
        return true;
      }
    }

    document.getElementById("refreshNow").addEventListener("click", () => {
      refreshAll();
      if (autoRefreshEl.checked) scheduleNextRefresh(new Date());
    });

    autoRefreshEl.addEventListener("change", () => setAutoRefresh(autoRefreshEl.checked));
    layoutSelectEl.addEventListener("change", () => setLayout(layoutSelectEl.value));

    document.addEventListener("visibilitychange", () => {
      if (autoRefreshEl.checked && !document.hidden){
        scheduleNextRefresh(new Date());
      }
    });

    setLayout(loadLayout());
    render();
    setAutoRefresh(loadAutoRefresh());
  </script>
</body>
</html>
